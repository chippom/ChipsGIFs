document.addEventListener("DOMContentLoaded",function(){function formatTimestamp(e){const t={timeZone:"America/New_York",weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0,timeZoneName:"short"};return new Date(e).toLocaleString("en-US",t)}if("caches"in window)caches.open("my-gif-cache").then(function(cache){document.querySelectorAll(".gif-item img").forEach(function(img){let gifURL=img.dataset.gif;/^https?:\/\//.test(gifURL)&&cache.add(gifURL).catch(err=>console.error("Failed to cache:",gifURL,err))})}).catch(err=>console.error("Failed to open cache:",err));const toggleBtn=document.getElementById("toggleDarkMode"),body=document.body;if(toggleBtn){toggleBtn.addEventListener("click",()=>{body.classList.toggle("dark-mode");localStorage.setItem("darkMode",body.classList.contains("dark-mode"))})}"true"===localStorage.getItem("darkMode")&&body.classList.add("dark-mode");const gifContainer=document.querySelector(".gif-container");if(gifContainer){gifContainer.addEventListener("click",e=>{if(e.target.classList.contains("download-btn"))return;const item=e.target.closest(".gif-item");if(item){const img=item.querySelector("img");if(img.src.includes("placeholder.jpg")&&img.dataset.gif)img.src=img.dataset.gif;const overlay=document.querySelector(".fullsize-overlay");overlay&&document.body.removeChild(overlay);const newOverlay=document.createElement("div");newOverlay.className="fullsize-overlay";const fullImg=document.createElement("img");fullImg.src=img.src,fullImg.className="fullsize-image",newOverlay.appendChild(fullImg),document.body.appendChild(newOverlay),newOverlay.addEventListener("click",()=>document.body.removeChild(newOverlay))}})}const starTrail=document.createElement("div");starTrail.style.position="fixed",starTrail.style.pointerEvents="none",starTrail.style.zIndex="9999",document.body.appendChild(starTrail);const stars=[],starCount=5;for(let i=0;i<starCount;i++){const star=document.createElement("div");star.textContent="★",star.className="star",starTrail.appendChild(star),stars.push(star)}let activeStar=0;document.addEventListener("mousemove",e=>{null!=e.clientX&&null!=e.clientY&&(stars[activeStar].style.left=e.clientX+"px",stars[activeStar].style.top=e.clientY+"px",stars[activeStar].style.opacity="1",setTimeout(()=>{stars[activeStar].style.opacity="0"},500),activeStar=(activeStar+1)%starCount)});document.querySelectorAll(".download-btn").forEach(function(button){const gifName=button.dataset.gif,label=button.nextElementSibling;fetch(`/.netlify/functions/get-download-count?gif_name=${encodeURIComponent(gifName)}`).then(res=>res.json()).then(data=>{if(label){label.textContent=`Downloads: ${data.count}`;if(data.timestamp){const stamp=formatTimestamp(data.timestamp),stampNode=document.createElement("div");stampNode.textContent=`Last downloaded: ${stamp}`,label.parentNode.appendChild(stampNode)}}});button.addEventListener("click",async()=>{try{const response=await fetch("/.netlify/functions/update-download-count",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({gif_name:gifName})}),result=await response.json();console.log("✅ Full response:",JSON.stringify(result)),label&&(label.textContent=`Downloads: ${result.count??"?"}`)}catch(error){console.error("Failed to update global count:",error)}const link=document.createElement("a");link.href=gifName,link.download=gifName,document.body.appendChild(link),link.click(),document.body.removeChild(link)})});const observer=new IntersectionObserver((entries,obs)=>{entries.forEach(entry=>{if(entry.isIntersecting){const img=entry.target;if(img.dataset.gif&&img.src.includes("placeholder.jpg"))img.src=img.dataset.gif,obs.unobserve(img)}})},{rootMargin:"400px"});document.querySelectorAll(".gif-item img").forEach(img=>{img.dataset.gif=img.src,img.src="placeholder.jpg",observer.observe(img)});function showConsentBanner(){const banner=document.createElement("div");banner.id="consent-banner",banner.innerHTML='<p>We use cookies to ensure you get the best experience. <button id="acceptConsent">Accept</button></p>',document.body.appendChild(banner);const acceptBtn=banner.querySelector("button");acceptBtn.addEventListener("click",()=>{banner.style.display="none",localStorage.setItem("cookiesAccepted","true"),document.querySelectorAll(".download-btn").forEach(btn=>btn.disabled=!1)})}"true"===localStorage.getItem("cookiesAccepted")?document.querySelectorAll(".download-btn").forEach(btn=>btn.disabled=!1):(document.querySelectorAll(".download-btn").forEach(btn=>btn.disabled=!0),showConsentBanner())});